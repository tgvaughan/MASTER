<!-- Example use of PopulationFunctionFromMaster simulation type
     to perform phylogenetic inference under a population function
     generated by a deterministic logistic model.

     Note that this is NOT a sensible way to analyse the included
     (primate) data! -->

<beast version='2.0'
       namespace='beast.core
                  :beast.evolution.alignment
                  :beast.evolution.tree
                  :beast.evolution.tree.coalescent
                  :beast.core.util
                  :beast.core.parameter
                  :beast.evolution.nuc
                  :beast.evolution.operators
                  :beast.evolution.sitemodel
                  :beast.evolution.substitutionmodel
                  :beast.evolution.likelihood
                  :master
                  :master.model
                  :master.steppers
                  :master.conditions
                  :master.outputs'>


    <!-- The sequence alignment (each sequence refers to a taxon
         above).  -->
    <!-- ntax=6 nchar=768                                                        -->
    <!-- npatterns=69                                                            -->
    <data id="alignment" dataType="nucleotide">
        <sequence taxon="human">
            AGAAATATGTCTGATAAAAGAGTTACTTTGATAGAGTAAATAATAGGAGCTTAAACCCCCTTATTTCTACTAGGACTATGAGAATCGAACCCATCCCTGAGAATCCAAAATTCTCCGTGCCACCTATCACACCCCATCCTAAGTAAGGTCAGCTAAATAAGCTATCGGGCCCATACCCCGAAAATGTTGGTTATACCCTTCCCGTACTAAGAAATTTAGGTTAAATACAGACCAAGAGCCTTCAAAGCCCTCAGTAAGTTG-CAATACTTAATTTCTGTAAGGACTGCAAAACCCCACTCTGCATCAACTGAACGCAAATCAGCCACTTTAATTAAGCTAAGCCCTTCTAGACCAATGGGACTTAAACCCACAAACACTTAGTTAACAGCTAAGCACCCTAATCAAC-TGGCTTCAATCTAAAGCCCCGGCAGG-TTTGAAGCTGCTTCTTCGAATTTGCAATTCAATATGAAAA-TCACCTCGGAGCTTGGTAAAAAGAGGCCTAACCCCTGTCTTTAGATTTACAGTCCAATGCTTCA-CTCAGCCATTTTACCACAAAAAAGGAAGGAATCGAACCCCCCAAAGCTGGTTTCAAGCCAACCCCATGGCCTCCATGACTTTTTCAAAAGGTATTAGAAAAACCATTTCATAACTTTGTCAAAGTTAAATTATAGGCT-AAATCCTATATATCTTA-CACTGTAAAGCTAACTTAGCATTAACCTTTTAAGTTAAAGATTAAGAGAACCAACACCTCTTTACAGTGA
        </sequence>
        <sequence taxon="chimp">
            AGAAATATGTCTGATAAAAGAATTACTTTGATAGAGTAAATAATAGGAGTTCAAATCCCCTTATTTCTACTAGGACTATAAGAATCGAACTCATCCCTGAGAATCCAAAATTCTCCGTGCCACCTATCACACCCCATCCTAAGTAAGGTCAGCTAAATAAGCTATCGGGCCCATACCCCGAAAATGTTGGTTACACCCTTCCCGTACTAAGAAATTTAGGTTAAGCACAGACCAAGAGCCTTCAAAGCCCTCAGCAAGTTA-CAATACTTAATTTCTGTAAGGACTGCAAAACCCCACTCTGCATCAACTGAACGCAAATCAGCCACTTTAATTAAGCTAAGCCCTTCTAGATTAATGGGACTTAAACCCACAAACATTTAGTTAACAGCTAAACACCCTAATCAAC-TGGCTTCAATCTAAAGCCCCGGCAGG-TTTGAAGCTGCTTCTTCGAATTTGCAATTCAATATGAAAA-TCACCTCAGAGCTTGGTAAAAAGAGGCTTAACCCCTGTCTTTAGATTTACAGTCCAATGCTTCA-CTCAGCCATTTTACCACAAAAAAGGAAGGAATCGAACCCCCTAAAGCTGGTTTCAAGCCAACCCCATGACCTCCATGACTTTTTCAAAAGATATTAGAAAAACTATTTCATAACTTTGTCAAAGTTAAATTACAGGTT-AACCCCCGTATATCTTA-CACTGTAAAGCTAACCTAGCATTAACCTTTTAAGTTAAAGATTAAGAGGACCGACACCTCTTTACAGTGA
        </sequence>
        <sequence taxon="bonobo">
            AGAAATATGTCTGATAAAAGAATTACTTTGATAGAGTAAATAATAGGAGTTTAAATCCCCTTATTTCTACTAGGACTATGAGAGTCGAACCCATCCCTGAGAATCCAAAATTCTCCGTGCCACCTATCACACCCCATCCTAAGTAAGGTCAGCTAAATAAGCTATCGGGCCCATACCCCGAAAATGTTGGTTATACCCTTCCCGTACTAAGAAATTTAGGTTAAACACAGACCAAGAGCCTTCAAAGCTCTCAGTAAGTTA-CAATACTTAATTTCTGTAAGGACTGCAAAACCCCACTCTGCATCAACTGAACGCAAATCAGCCACTTTAATTAAGCTAAGCCCTTCTAGATTAATGGGACTTAAACCCACAAACATTTAGTTAACAGCTAAACACCCTAATCAGC-TGGCTTCAATCTAAAGCCCCGGCAGG-TTTGAAGCTGCTTCTTTGAATTTGCAATTCAATATGAAAA-TCACCTCAGAGCTTGGTAAAAAGAGGCTTAACCCCTGTCTTTAGATTTACAGTCCAATGCTTCA-CTCAGCCATTTTACCACAAAAAAGGAAGGAATCGAACCCCCTAAAGCTGGTTTCAAGCCAACCCCATGACCCCCATGACTTTTTCAAAAGATATTAGAAAAACTATTTCATAACTTTGTCAAAGTTAAATTACAGGTT-AAACCCCGTATATCTTA-CACTGTAAAGCTAACCTAGCATTAACCTTTTAAGTTAAAGATTAAGAGGACCAACACCTCTTTACAGTGA
        </sequence>
        <sequence taxon="gorilla">
            AGAAATATGTCTGATAAAAGAGTTACTTTGATAGAGTAAATAATAGAGGTTTAAACCCCCTTATTTCTACTAGGACTATGAGAATTGAACCCATCCCTGAGAATCCAAAATTCTCCGTGCCACCTGTCACACCCCATCCTAAGTAAGGTCAGCTAAATAAGCTATCGGGCCCATACCCCGAAAATGTTGGTCACATCCTTCCCGTACTAAGAAATTTAGGTTAAACATAGACCAAGAGCCTTCAAAGCCCTTAGTAAGTTA-CAACACTTAATTTCTGTAAGGACTGCAAAACCCTACTCTGCATCAACTGAACGCAAATCAGCCACTTTAATTAAGCTAAGCCCTTCTAGATCAATGGGACTCAAACCCACAAACATTTAGTTAACAGCTAAACACCCTAGTCAAC-TGGCTTCAATCTAAAGCCCCGGCAGG-TTTGAAGCTGCTTCTTCGAATTTGCAATTCAATATGAAAT-TCACCTCGGAGCTTGGTAAAAAGAGGCCCAGCCTCTGTCTTTAGATTTACAGTCCAATGCCTTA-CTCAGCCATTTTACCACAAAAAAGGAAGGAATCGAACCCCCCAAAGCTGGTTTCAAGCCAACCCCATGACCTTCATGACTTTTTCAAAAGATATTAGAAAAACTATTTCATAACTTTGTCAAGGTTAAATTACGGGTT-AAACCCCGTATATCTTA-CACTGTAAAGCTAACCTAGCGTTAACCTTTTAAGTTAAAGATTAAGAGTATCGGCACCTCTTTGCAGTGA
        </sequence>
        <sequence taxon="orangutan">
            AGAAATATGTCTGACAAAAGAGTTACTTTGATAGAGTAAAAAATAGAGGTCTAAATCCCCTTATTTCTACTAGGACTATGGGAATTGAACCCACCCCTGAGAATCCAAAATTCTCCGTGCCACCCATCACACCCCATCCTAAGTAAGGTCAGCTAAATAAGCTATCGGGCCCATACCCCGAAAATGTTGGTTACACCCTTCCCGTACTAAGAAATTTAGGTTA--CACAGACCAAGAGCCTTCAAAGCCCTCAGCAAGTCA-CAGCACTTAATTTCTGTAAGGACTGCAAAACCCCACTTTGCATCAACTGAGCGCAAATCAGCCACTTTAATTAAGCTAAGCCCTCCTAGACCGATGGGACTTAAACCCACAAACATTTAGTTAACAGCTAAACACCCTAGTCAAT-TGGCTTCAGTCCAAAGCCCCGGCAGGCCTTAAAGCTGCTCCTTCGAATTTGCAATTCAACATGACAA-TCACCTCAGGGCTTGGTAAAAAGAGGTCTGACCCCTGTTCTTAGATTTACAGCCTAATGCCTTAACTCGGCCATTTTACCGCAAAAAAGGAAGGAATCGAACCTCCTAAAGCTGGTTTCAAGCCAACCCCATAACCCCCATGACTTTTTCAAAAGGTACTAGAAAAACCATTTCGTAACTTTGTCAAAGTTAAATTACAGGTC-AGACCCTGTGTATCTTA-CATTGCAAAGCTAACCTAGCATTAACCTTTTAAGTTAAAGACTAAGAGAACCAGCCTCTCTTTGCAATGA
        </sequence>
        <sequence taxon="siamang">
            AGAAATACGTCTGACGAAAGAGTTACTTTGATAGAGTAAATAACAGGGGTTTAAATCCCCTTATTTCTACTAGAACCATAGGAGTCGAACCCATCCTTGAGAATCCAAAACTCTCCGTGCCACCCGTCGCACCCTGTTCTAAGTAAGGTCAGCTAAATAAGCTATCGGGCCCATACCCCGAAAATGTTGGTTATACCCTTCCCATACTAAGAAATTTAGGTTAAACACAGACCAAGAGCCTTCAAAGCCCTCAGTAAGTTAACAAAACTTAATTTCTGCAAGGGCTGCAAAACCCTACTTTGCATCAACCGAACGCAAATCAGCCACTTTAATTAAGCTAAGCCCTTCTAGATCGATGGGACTTAAACCCATAAAAATTTAGTTAACAGCTAAACACCCTAAACAACCTGGCTTCAATCTAAAGCCCCGGCAGA-GTTGAAGCTGCTTCTTTGAACTTGCAATTCAACGTGAAAAATCACTTCGGAGCTTGGCAAAAAGAGGTTTCACCTCTGTCCTTAGATTTACAGTCTAATGCTTTA-CTCAGCCACTTTACCACAAAAAAGGAAGGAATCGAACCCTCTAAAACCGGTTTCAAGCCAGCCCCATAACCTTTATGACTTTTTCAAAAGATATTAGAAAAACTATTTCATAACTTTGTCAAAGTTAAATCACAGGTCCAAACCCCGTATATCTTATCACTGTAGAGCTAGACCAGCATTAACCTTTTAAGTTAAAGACTAAGAGAACTACCGCCTCTTTACAGTGA
        </sequence>
    </data>

    <!-- The HKY substitution model (Hasegawa, Kishino & Yano, 1985) -->
    <input spec='HKY' id="hky">
        <parameter name='kappa' idref='hky.kappa'/>
        <input id='freqs' name='frequencies' spec='Frequencies'>
            <input name='data' idref='alignment'/>
        </input>
    </input>

    <!-- Site model -->
    <input spec='SiteModel' id="siteModel">
      <mutationRate spec='RealParameter' value="0.001"/>
        <input name='substModel' idref='hky'/>
    </input>

    <!-- Starting tree -->
    <tree spec='beast.util.ClusterTree' id='tree' clusterType='upgma'>
        <input name='taxa' idref='alignment'/>
        <taxonset spec="TaxonSet" alignment="@alignment"/>
    </tree>

    <input spec='beast.core.parameter.RealParameter' id="hky.kappa">1.0</input>

    <!-- Tree likelihood given sequence alignment -->    
    <distribution spec='TreeLikelihood' id="treeLikelihood">
        <input name='data' idref="alignment"/>
        <input name='tree' idref="tree"/>
        <input name='siteModel' idref="siteModel"/>
    </distribution>

    <!-- Coalescent ree prior using population size trajectory from MASTER -->
    <distribution id="treePrior" spec="Coalescent">
      <treeIntervals spec='TreeIntervals' id='TreeIntervals'>
        <tree idref="tree"/>
      </treeIntervals>

      <populationModel spec='PopulationFunctionFromMaster'
                       popSizeExpression="X"
                       popSizeStart="1.0"
                       popSizeEnd="100.0"
                       simulationTime="50.0"
                       origin="50.0">
        
        <stepper spec='RateEquationStepper' stepSize="0.01" />
        
        <model spec='Model' id='model'>
          <population spec='Population' populationName="X" id='X'/>
          <reaction spec='Reaction' reactionName="Birth" rate="0.2">
            X -> 2X
          </reaction>
          <reaction spec='Reaction' reactionName="Death" rate="0.002">
            2X -> X
          </reaction>
        </model>
        
        <initialState spec='InitState'>
          <populationSize spec='PopulationSize' population="@X" size='1'/>
        </initialState>

        <!-- Record population function used in inference. -->
        <output spec='JsonOutput' fileName="$(filebase)_popTraj.json"/>
      </populationModel>

    </distribution>

    <distribution id="parameterPriors" spec="CompoundDistribution">
      <distribution spec="beast.math.distributions.Prior" x="@hky.kappa">
        <distr spec="beast.math.distributions.OneOnX"/>
      </distribution>
    </distribution>

    <run spec="MCMC" id="mcmc" chainLength="1000000"> <!--autoOptimize="true"-->
        <state>
            <input name='stateNode' idref='hky.kappa'/>
            <input name='stateNode' idref='tree'/>
        </state>

        <distribution spec="CompoundDistribution" id="posterior">
          <distribution idref="treeLikelihood"/>
          <distribution idref="treePrior"/>
          <distribution idref="parameterPriors"/>
        </distribution>

        <operator id='kappaScaler' spec='ScaleOperator' scaleFactor="0.5" weight="1">
            <parameter idref="hky.kappa"/>
        </operator>
        <operator id='treeScaler' spec='ScaleOperator' scaleFactor="0.5" weight="1">
            <tree idref="tree"/>
        </operator>
        <operator spec='Uniform' weight="10">
            <tree idref="tree"/>
        </operator>
        <operator spec='SubtreeSlide' weight="5" gaussian="true" size="1.0">
            <tree idref="tree"/>
        </operator>
        <operator id='narrow' spec='Exchange' isNarrow='true' weight="1">
            <tree idref="tree"/>
        </operator>
        <operator id='wide' spec='Exchange' isNarrow='false' weight="1">
            <tree idref="tree"/>
        </operator>
        <operator spec='WilsonBalding' weight="1">
            <tree idref="tree"/>
        </operator>

        <logger logEvery="10000" fileName="$(filebase).log">
          <model idref='posterior'/>
            <log idref="posterior"/>
            <log idref="treeLikelihood"/>
            <log idref="treePrior"/>
            <log idref="parameterPriors"/>
            <log idref="hky.kappa"/>
            <log spec='TreeHeightLogger' tree="@tree"/>
        </logger>
        <logger logEvery="10000" fileName="$(filebase).trees">
            <log idref="tree"/>
        </logger>
        <logger logEvery="10000">
          <model idref='posterior'/>
            <log idref="posterior"/>
            <log idref="treeLikelihood"/>
            <log idref="treePrior"/>
            <log idref="parameterPriors"/>
            <log idref="hky.kappa"/>
            <log spec='TreeHeightLogger' tree="@tree"/>
        </logger>
    </run>

</beast>
